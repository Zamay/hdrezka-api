<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HdRezka API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            background: #ffebee;
            border-color: #f44336;
            color: #d32f2f;
        }
        .success {
            background: #e8f5e8;
            border-color: #4CAF50;
            color: #2e7d32;
        }
        .loading {
            color: #ff9800;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .translation-item {
            padding: 5px;
            margin: 2px 0;
            background: #e3f2fd;
            border-radius: 3px;
            cursor: pointer;
        }
        .translation-item:hover {
            background: #bbdefb;
        }
        #seasonEpisodeControls {
            display: none; /* –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ, –ø–æ–∫–∞–∑—É—î–º–æ –¥–ª—è —Å–µ—Ä—ñ–∞–ª—ñ–≤ */
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è (–¥–ª—è –æ–±—Ö–æ–¥—É –±–ª–æ–∫—É–≤–∞–Ω–Ω—è)</h2>
        <div id="loginContainer">
            <div class="form-group">
                <label for="login">–õ–æ–≥—ñ–Ω:</label>
                <input type="text" id="login" placeholder="–í–∞—à –ª–æ–≥—ñ–Ω –Ω–∞ hdrezka">
            </div>
            <div class="form-group">
                <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="password" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å">
            </div>
            <button onclick="login()">–£–≤—ñ–π—Ç–∏</button>
        </div>
        <div id="logoutContainer" style="display: none;">
            <p id="loggedInStatus" class="result success" style="text-align: center;"></p>
            <button onclick="logout()" style="background-color: #f44336; margin-top: 10px;">–í–∏–π—Ç–∏</button>
        </div>
        <div id="loginResult" class="result" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>üé¨ HdRezka API Tester</h2>
        
        <div class="form-group">
            <label for="url">URL —Å–∞–π—Ç—É:</label>
            <input type="url" id="url" placeholder="https://hdrezka.ag/..." 
                   value="https://hdrezka.ag/films/fiction/500-interstellar-2014.html">
        </div>

        <button onclick="parseContent()">üì• –ü–∞—Ä—Å–∏—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç</button>
        <div id="parseResult" class="result" style="display: none;"></div>
    </div>

    <div class="container" id="streamContainer" style="display: none;">
        <h2>üé• –û—Ç—Ä–∏–º–∞—Ç–∏ —Å—Ç—Ä—ñ–º</h2>
        
        <div class="form-group">
            <label for="translation">–ü–µ—Ä–µ–∫–ª–∞–¥:</label>
            <select id="translation"></select>
        </div>

        <div id="seasonEpisodeControls">
            <div class="form-group">
                <label for="season">–°–µ–∑–æ–Ω:</label>
                <select id="season"></select>
            </div>

            <div class="form-group">
                <label for="episode">–°–µ—Ä—ñ—è:</label>
                <select id="episode"></select>
            </div>
        </div>

        <button onclick="getStream()">üé¨ –û—Ç—Ä–∏–º–∞—Ç–∏ —Å—Ç—Ä—ñ–º</button>
        <div id="streamResult" class="result" style="display: none;"></div>
        
        <div id="videoContainer" style="display: none; margin-top: 20px;">
            <h3>üì∫ –í—ñ–¥–µ–æ –ø–ª–µ—î—Ä</h3>
            <div class="form-group">
                <label for="qualitySelect">–Ø–∫—ñ—Å—Ç—å –≤—ñ–¥–µ–æ:</label>
                <select id="qualitySelect" onchange="changeVideoQuality()"></select>
            </div>
            <video id="videoPlayer" controls style="width: 100%; max-width: 800px; height: auto;">
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≤—ñ–¥–µ–æ
            </video>
            <div id="videoInfo" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api'; // –í—ñ–¥–Ω–æ—Å–Ω–∏–π —à–ª—è—Ö –¥–ª—è —Ä–æ–±–æ—Ç–∏ –Ω–∞ Vercel
        let currentData = null; // –ó–±–µ—Ä—ñ–≥–∞—î –¥–∞–Ω—ñ, –æ—Ç—Ä–∏–º–∞–Ω—ñ –ø—ñ—Å–ª—è –ø–∞—Ä—Å–∏–Ω–≥—É (–Ω–∞–∑–≤–∞, –ø–µ—Ä–µ–∫–ª–∞–¥–∏, —Å–µ–∑–æ–Ω–∏)
        let currentStreamData = null; // –ó–±–µ—Ä—ñ–≥–∞—î –¥–∞–Ω—ñ —Å—Ç—Ä—ñ–º—É (–ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –≤—ñ–¥–µ–æ, —Å–µ–∑–æ–Ω, —Å–µ—Ä—ñ—è)
        let sessionCookie = localStorage.getItem('hdrezkaSessionCookie') || null; // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫—É–∫–∏ –∑ localStorage –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ

        const urlInput = document.getElementById('url');
        const parseResultDiv = document.getElementById('parseResult');
        const streamContainerDiv = document.getElementById('streamContainer');
        const translationSelect = document.getElementById('translation');
        const seasonSelect = document.getElementById('season');
        const episodeSelect = document.getElementById('episode');
        const streamResultDiv = document.getElementById('streamResult');
        const videoContainerDiv = document.getElementById('videoContainer');
        const qualitySelect = document.getElementById('qualitySelect');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoInfoDiv = document.getElementById('videoInfo');
        const seasonEpisodeControls = document.getElementById('seasonEpisodeControls');
        const loginInput = document.getElementById('login');
        const passwordInput = document.getElementById('password');
        const loginResultDiv = document.getElementById('loginResult');
        const loginContainer = document.getElementById('loginContainer');
        const logoutContainer = document.getElementById('logoutContainer');
        const loggedInStatus = document.getElementById('loggedInStatus');

        function showResult(element, data, isError = false) {
            element.style.display = 'block';
            element.className = `result ${isError ? 'error' : 'success'}`;
            element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        }

        function showLoading(element, message = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...') {
            element.style.display = 'block';
            element.className = 'result loading';
            element.textContent = message;
        }

        function updateLoginUI() {
            if (sessionCookie) {
                loginContainer.style.display = 'none';
                logoutContainer.style.display = 'block';
                loginResultDiv.style.display = 'none';
                loggedInStatus.textContent = '–í–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ. –ú–æ–∂–Ω–∞ –ø–∞—Ä—Å–∏—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç.';
            } else {
                loginContainer.style.display = 'block';
                logoutContainer.style.display = 'none';
                loginInput.value = '';
                passwordInput.value = '';
            }
        }

        function logout() {
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–π—Ç–∏?')) {
                sessionCookie = null;
                localStorage.removeItem('hdrezkaSessionCookie');
                loginResultDiv.style.display = 'none';
                alert('–í–∏ –≤–∏–π—à–ª–∏ –∑ –∞–∫–∞—É–Ω—Ç—É.');
                updateLoginUI();
            }
        }

        async function login() {
            const login = loginInput.value;
            const password = passwordInput.value;

            if (!login || !password) {
                alert('–í–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω —Ç–∞ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            showLoading(loginResultDiv, '–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –≤—Ö—ñ–¥...');
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ login, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó');
                }

                sessionCookie = data.cookie; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫—É–∫–∏ —É –∑–º—ñ–Ω–Ω—É
                localStorage.setItem('hdrezkaSessionCookie', data.cookie); // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ localStorage
                showResult(loginResultDiv, '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –¢–µ–ø–µ—Ä –º–æ–∂–Ω–∞ –ø–∞—Ä—Å–∏—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç.');
                updateLoginUI();
            } catch (error) {
                sessionCookie = null;
                localStorage.removeItem('hdrezkaSessionCookie');
                showResult(loginResultDiv, `–ü–æ–º–∏–ª–∫–∞: ${error.message}`, true);
            }
        }

        async function parseContent() {
            const url = urlInput.value;
            if (!url) {
                alert('–í–≤–µ–¥—ñ—Ç—å URL!');
                return;
            }

            showLoading(parseResultDiv, '–ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–Ω—Ç–µ–Ω—Ç—É...');
            streamContainerDiv.style.display = 'none'; // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —Ñ–æ—Ä–º—É —Å—Ç—Ä—ñ–º—É
            videoContainerDiv.style.display = 'none'; // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—ñ–¥–µ–æ–ø–ª–µ—î—Ä
            
            try {
                const response = await fetch(`${API_BASE}/parse`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, cookie: sessionCookie }) // –ù–∞–¥—Å–∏–ª–∞—î–º–æ –∫—É–∫–∏
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥—É');
                }

                currentData = data;
                showResult(parseResultDiv, data);
                
                // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –ø–µ—Ä–µ–∫–ª–∞–¥–∏
                fillTranslations(data.translations);

                // –ó–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–∏–ø—É –∫–æ–Ω—Ç–µ–Ω—Ç—É, –ø–æ–∫–∞–∑—É—î–º–æ/—Ö–æ–≤–∞—î–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏ –¥–ª—è —Å–µ—Ä—ñ–π
                if (data.type === 'video.tv_series') {
                    seasonEpisodeControls.style.display = 'block';
                    fillSeasonsAndEpisodes(data);
                } else {
                    seasonEpisodeControls.style.display = 'none';
                }
                
                streamContainerDiv.style.display = 'block'; // –ü–æ–∫–∞–∑—É—î–º–æ —Ñ–æ—Ä–º—É —Å—Ç—Ä—ñ–º—É
                
            } catch (error) {
                showResult(parseResultDiv, `–ü–æ–º–∏–ª–∫–∞: ${error.message}`, true);
            }
        }

        function fillTranslations(translations) {
            translationSelect.innerHTML = '';
            for (const [name, id] of Object.entries(translations)) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                translationSelect.appendChild(option);
            }
        }

        // –ó–∞–ø–æ–≤–Ω—é—î —Å–µ–∑–æ–Ω–∏ —Ç–∞ –µ–ø—ñ–∑–æ–¥–∏ –¥–ª—è —Å–µ—Ä—ñ–∞–ª—ñ–≤
        function fillSeasonsAndEpisodes(data) {
            seasonSelect.innerHTML = '';
            episodeSelect.innerHTML = '';

            const selectedTranslatorId = translationSelect.value;
            const translatorName = Object.keys(data.translations).find(key => data.translations[key] === selectedTranslatorId);
            
            if (translatorName && data.seasons && data.seasons[translatorName]) {
                const seasonsInfoForTranslator = data.seasons[translatorName];
                
                // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Å–µ–∑–æ–Ω–∏
                for (const [id, name] of Object.entries(seasonsInfoForTranslator.seasons)) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    seasonSelect.appendChild(option);
                }
                
                // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Å–µ—Ä—ñ—ó –¥–ª—è –ø–µ—Ä—à–æ–≥–æ —Å–µ–∑–æ–Ω—É (–∞–±–æ –≤–∏–±—Ä–∞–Ω–æ–≥–æ)
                if (Object.keys(seasonsInfoForTranslator.seasons).length > 0) {
                    const firstSeasonId = Object.keys(seasonsInfoForTranslator.seasons)[0];
                    fillEpisodes(firstSeasonId);
                }
            }
        }

        function fillEpisodes(seasonId) {
            episodeSelect.innerHTML = '';
            
            if (!currentData || !currentData.seasons) return;
            
            const selectedTranslatorId = translationSelect.value;
            const translatorName = Object.keys(currentData.translations).find(key => currentData.translations[key] === selectedTranslatorId);

            if (translatorName && currentData.seasons[translatorName] && 
                currentData.seasons[translatorName].episodes && 
                currentData.seasons[translatorName].episodes[seasonId]) {
                
                const episodes = currentData.seasons[translatorName].episodes[seasonId];
                for (const [id, name] of Object.entries(episodes)) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    episodeSelect.appendChild(option);
                }
            }
        }

        // –û–±—Ä–æ–±–Ω–∏–∫ –∑–º—ñ–Ω–∏ –ø–µ—Ä–µ–∫–ª–∞–¥—É (–¥–ª—è —Å–µ—Ä—ñ–∞–ª—ñ–≤)
        translationSelect.addEventListener('change', function() {
            if (currentData && currentData.type === 'video.tv_series') {
                fillSeasonsAndEpisodes(currentData);
            }
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –∑–º—ñ–Ω–∏ —Å–µ–∑–æ–Ω—É
        seasonSelect.addEventListener('change', function() {
            fillEpisodes(this.value);
        });

        async function getStream() {
            const url = urlInput.value;
            const translation = translationSelect.value;
            let season = null;
            let episode = null;

            if (!url || !translation) {
                alert('–°–ø–æ—á–∞—Ç–∫—É –ø–∞—Ä—Å—ñ—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç —Ç–∞ –≤–∏–±–µ—Ä—ñ—Ç—å –ø–µ—Ä–µ–∫–ª–∞–¥!');
                return;
            }

            if (currentData && currentData.type === 'video.tv_series') {
                season = seasonSelect.value;
                episode = episodeSelect.value;
                if (!season || !episode) {
                    alert('–î–ª—è —Å–µ—Ä—ñ–∞–ª—É –≤–∏–±–µ—Ä—ñ—Ç—å —Å–µ–∑–æ–Ω —ñ —Å–µ—Ä—ñ—é!');
                    return;
                }
            }

            showLoading(streamResultDiv, '–û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç—Ä—ñ–º—É...');
            videoContainerDiv.style.display = 'none'; // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –ø–ª–µ—î—Ä –ø—ñ–¥ —á–∞—Å –Ω–æ–≤–æ–≥–æ –∑–∞–ø–∏—Ç—É
            
            try {
                const requestData = { url, translation, cookie: sessionCookie }; // –ù–∞–¥—Å–∏–ª–∞—î–º–æ –∫—É–∫–∏
                if (season) requestData.season = season;
                if (episode) requestData.episode = episode;

                const response = await fetch(`${API_BASE}/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ —Å—Ç—Ä—ñ–º—É');
                }

                currentStreamData = data;
                showResult(streamResultDiv, data);
                
                // –ü–æ–∫–∞–∑—É—î–º–æ –≤—ñ–¥–µ–æ –ø–ª–µ—î—Ä
                if (data.videos && Object.keys(data.videos).length > 0) {
                    showVideoPlayer(data.videos);
                } else {
                    showResult(streamResultDiv, '–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –≤—ñ–¥–µ–æ–ø–æ—Ç–æ–∫—ñ–≤.', true);
                }
                
            } catch (error) {
                showResult(streamResultDiv, `–ü–æ–º–∏–ª–∫–∞: ${error.message}`, true);
            }
        }

        function showVideoPlayer(videos) {
            const qualities = Object.keys(videos).sort((a, b) => {
                const aNum = parseInt(a); // –ü—Ä–∏–ø—É—Å–∫–∞—î–º–æ, —â–æ —è–∫—ñ—Å—Ç—å —É —Ñ–æ—Ä–º–∞—Ç—ñ "1080p", "720p"
                const bNum = parseInt(b);
                return bNum - aNum; // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –≤—ñ–¥ –Ω–∞–π–≤–∏—â–æ—ó –¥–æ –Ω–∞–π–Ω–∏–∂—á–æ—ó —è–∫–æ—Å—Ç—ñ
            });
            
            qualitySelect.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –æ–ø—Ü—ñ—ó
            qualities.forEach(quality => {
                const option = document.createElement('option');
                option.value = quality;
                option.textContent = quality;
                qualitySelect.appendChild(option);
            });
            
            if (qualities.length > 0) {
                const bestQuality = qualities[0];
                qualitySelect.value = bestQuality;
                videoPlayer.src = videos[bestQuality];
                videoPlayer.load(); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω–æ–≤–µ –≤—ñ–¥–µ–æ
                updateVideoInfo(bestQuality, videos[bestQuality]);
            }
            
            videoContainerDiv.style.display = 'block';
        }

        function changeVideoQuality() {
            const selectedQuality = qualitySelect.value;
            
            if (currentStreamData && currentStreamData.videos[selectedQuality]) {
                const currentTime = videoPlayer.currentTime; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å
                videoPlayer.src = currentStreamData.videos[selectedQuality];
                videoPlayer.load();
                videoPlayer.currentTime = currentTime; // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —á–∞—Å
                videoPlayer.play(); // –°–ø—Ä–æ–±–∞ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
                updateVideoInfo(selectedQuality, currentStreamData.videos[selectedQuality]);
            }
        }

        function updateVideoInfo(quality, url) {
            const urlShort = url.length > 100 ? url.substring(0, 100) + '...' : url;
            
            let seasonEpisode = '';
            if (currentStreamData.season && currentStreamData.episode) {
                seasonEpisode = `–°–µ–∑–æ–Ω ${currentStreamData.season}, –°–µ—Ä—ñ—è ${currentStreamData.episode} | `;
            }
            
            videoInfoDiv.innerHTML = `
                <strong>–Ø–∫—ñ—Å—Ç—å:</strong> ${quality} | 
                ${seasonEpisode}
                <strong>URL:</strong> <a href="${url}" target="_blank" style="color: #4CAF50;">${urlShort}</a>
            `;
        }

        // –ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        window.addEventListener('load', function() {
            updateLoginUI(); // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
            if (urlInput.value) {
                // –ú–æ–∂–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–∞—Ä—Å–∏—Ç–∏ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ, —è–∫—â–æ URL –≤–∂–µ —î
                // parseContent(); 
            }
        });
    </script>
</body>
</html>